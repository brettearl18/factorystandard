rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isStaff() {
      return request.auth != null &&
        (request.auth.token.role == "staff" || request.auth.token.role == "admin" || request.auth.token.role == "factory" || request.auth.token.role == "accounting");
    }

    function isAccounting() {
      return request.auth != null &&
        (request.auth.token.role == "accounting" || request.auth.token.role == "admin");
    }

    function isClient() {
      return request.auth != null &&
        request.auth.token.role == "client";
    }

    match /runs/{runId} {
      allow read, write: if isStaff();
      // Allow clients to read runs (needed to get stage info for their guitars)
      allow read: if isClient();
      
      match /stages/{stageId} {
        allow read, write: if isStaff();
        // Allow clients to read stages (needed to display progress for their guitars)
        // Security: Clients can only access stages for runs where they have guitars
        // This is enforced because clients only get runIds from their own guitars
        allow read: if isClient();
      }
    }

    match /guitars/{guitarId} {
      allow read, write: if isStaff();
      allow read: if isClient() &&
                    resource.data.clientUid != null &&
                    resource.data.clientUid == request.auth.uid;
      // Accounting can read guitars to manage invoices
      allow read: if isAccounting();
      
      match /notes/{noteId} {
        allow read, write: if isStaff();
        // Allow clients to read notes for their guitars that are visible to them
        // Note: Collection queries must filter by visibleToClient == true in the query
        allow read: if isClient() &&
          get(/databases/$(database)/documents/guitars/$(guitarId)).data.clientUid != null &&
          get(/databases/$(database)/documents/guitars/$(guitarId)).data.clientUid ==
            request.auth.uid &&
          resource.data.visibleToClient == true;
      }
    }

    function ownsNotification() {
      return resource.data.userId == request.auth.uid;
    }

    // Notifications - staff/admin + clients (own notifications)
    match /notifications/{notificationId} {
      allow read: if (isStaff() || isClient()) && ownsNotification();
      allow write: if isStaff();
      allow create: if isStaff();
      allow update: if (isStaff() || isClient()) && ownsNotification();
      allow delete: if (isStaff() || isClient()) && ownsNotification();
    }

    match /clients/{clientId} {
      allow read, write: if isStaff();
      allow read, update: if isClient() && request.auth.uid == clientId;
      // Accounting can read client profiles to get names/emails for invoices
      allow read: if isAccounting();

      match /invoices/{invoiceId} {
        allow read: if isStaff() || (isClient() && request.auth.uid == clientId);
        allow write: if isStaff();
        // Accounting can read and write invoices for payment recording
        allow read, write: if isAccounting();
      }
    }

    // Collection group query for invoices (used by accounting dashboard)
    // This allows accounting users to query all invoices across all clients
    match /{path=**}/invoices/{invoiceId} {
      allow read: if isAccounting();
      allow write: if isAccounting();
    }

    // App Settings - public read (for branding on login page), staff/admin can write
    match /settings/{settingsId} {
      allow read: if true; // Public read for branding on login page
      allow write: if request.auth != null && (request.auth.token.role == "admin" || request.auth.token.role == "staff");
    }
  }
}

