rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isStaff() {
      return request.auth != null &&
        (request.auth.token.role == "staff" || request.auth.token.role == "admin" || request.auth.token.role == "factory" || request.auth.token.role == "accounting");
    }

    function isAccounting() {
      return request.auth != null &&
        (request.auth.token.role == "accounting" || request.auth.token.role == "admin");
    }

    function isClient() {
      return request.auth != null &&
        request.auth.token.role == "client";
    }

    match /runs/{runId} {
      allow read, write: if isStaff();
      // Allow clients to read runs (needed to get stage info for their guitars)
      allow read: if isClient();
      
      match /stages/{stageId} {
        allow read, write: if isStaff();
        // Allow clients to read stages (needed to display progress for their guitars)
        // Security: Clients can only access stages for runs where they have guitars
        // This is enforced because clients only get runIds from their own guitars
        allow read: if isClient();
      }

      match /updates/{updateId} {
        // Clients can read updates visible to them
        allow read: if request.auth != null &&
                       (isStaff() ||
                        (isClient() && resource.data.visibleToClients == true));
        // Only staff can create/delete updates
        allow create, delete: if isStaff();
        // Staff or client can update (client only for viewedBy thumbs up)
        allow update: if isStaff() ||
          (isClient() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewedBy']));
        match /comments/{commentId} {
          allow read, create: if request.auth != null && (isStaff() || isClient());
          allow update, delete: if isStaff();
        }
      }
    }

    match /guitars/{guitarId} {
      allow read, write: if isStaff();
      allow read: if isClient() &&
                    resource.data.clientUid != null &&
                    resource.data.clientUid == request.auth.uid;
      // Accounting can read guitars to manage invoices
      allow read: if isAccounting();
      // Allow clients to create guitars (for onboarding)
      // Security: Only allow if clientUid matches the authenticated user
      allow create: if isClient() &&
                     request.resource.data.clientUid == request.auth.uid &&
                     // Ensure required fields are present
                     request.resource.data.runId != null &&
                     request.resource.data.stageId != null &&
                     request.resource.data.orderNumber != null &&
                     request.resource.data.model != null &&
                     request.resource.data.finish != null;
      // Allow clients to update referenceImages on their own guitars (for gallery uploads)
      allow update: if isClient() &&
                     resource.data.clientUid != null &&
                     resource.data.clientUid == request.auth.uid &&
                     // Only allow updating referenceImages and updatedAt
                     // Check that only allowed fields are being changed
                     request.resource.data.diff(resource.data).affectedKeys().hasOnly(['referenceImages', 'updatedAt']);
      
      match /notes/{noteId} {
        allow read, create, delete: if isStaff();
        // Allow clients to read notes for their guitars that are visible to them
        allow read: if isClient() &&
          resource.data.visibleToClient == true &&
          exists(/databases/$(database)/documents/guitars/$(guitarId)) &&
          get(/databases/$(database)/documents/guitars/$(guitarId)).data.clientUid == request.auth.uid;
        // Allow client (guitar owner) to update only viewedBy (thumbs up)
        allow update: if isStaff() ||
          (isClient() &&
           get(/databases/$(database)/documents/guitars/$(guitarId)).data.clientUid == request.auth.uid &&
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewedBy']));
        match /comments/{commentId} {
          allow read, create: if isStaff() ||
            (isClient() &&
             get(/databases/$(database)/documents/guitars/$(guitarId)).data.clientUid == request.auth.uid);
          allow update, delete: if isStaff();
        }
      }
    }

    function ownsNotification() {
      return resource.data.userId == request.auth.uid;
    }

    // Notifications - staff/admin + clients (own notifications)
    match /notifications/{notificationId} {
      allow read: if (isStaff() || isClient()) && ownsNotification();
      allow write: if isStaff();
      allow create: if isStaff();
      allow update: if (isStaff() || isClient()) && ownsNotification();
      allow delete: if (isStaff() || isClient()) && ownsNotification();
    }

    match /clients/{clientId} {
      allow read, write: if isStaff();
      // Client (by role) or document owner so client view shows profile and order total
      allow read, update: if (isClient() && request.auth.uid == clientId) || (request.auth != null && request.auth.uid == clientId);
      // Accounting can read client profiles to get names/emails for invoices
      allow read: if isAccounting();

      match /invoices/{invoiceId} {
        // Staff/accounting, or client (by role), or document owner so payments show in client view
        allow read: if isStaff() || (isClient() && request.auth.uid == clientId) || (request.auth != null && request.auth.uid == clientId);
        allow write: if isStaff();
        // Accounting can read and write invoices for payment recording
        allow read, write: if isAccounting();
        // Clients can update their own invoices to add pending payments
        // Note: Application code validates that only pending payments with recordedBy="client" are added
        allow update: if isClient() && request.auth.uid == clientId &&
          // Only allow updating payments array and status (which is recalculated)
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['payments', 'status']);
      }
    }

    // Collection group query for invoices (used by accounting dashboard and guitar-specific queries)
    // This allows accounting users to query all invoices across all clients
    // Also allows clients to read invoices for guitars they own
    match /{path=**}/invoices/{invoiceId} {
      allow read: if isAccounting();
      allow write: if isAccounting();
      // Allow clients to read invoices for their own guitars
      // Security: Check if the invoice's guitarId belongs to the client
      allow read: if isClient() &&
                     resource.data.guitarId != null &&
                     exists(/databases/$(database)/documents/guitars/$(resource.data.guitarId)) &&
                     get(/databases/$(database)/documents/guitars/$(resource.data.guitarId)).data.clientUid == request.auth.uid;
      // Also allow clients to read invoices directly under their client profile (or owner by path)
      allow read: if (isClient() || request.auth != null) &&
                     path.matches("clients/{clientId}/invoices/{invoiceId}") &&
                     path.split("/")[1] == request.auth.uid;
    }

    // App Settings - public read (for branding on login page), staff/admin can write
    match /settings/{settingsId} {
      allow read: if true; // Public read for branding on login page
      allow write: if request.auth != null && (request.auth.token.role == "admin" || request.auth.token.role == "staff");
    }

    // Audit logs - users can create their own entries (userId must match); staff/admin can read
    match /auditLogs/{logId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read: if isStaff();
      allow update, delete: if false;
    }

    // Custom Shop requests - any signed-in user can create and read their own; staff can read/write all
    match /customShopRequests/{requestId} {
      allow create: if request.auth != null &&
        request.resource.data.submitterUid == request.auth.uid;
      allow read: if request.auth != null &&
        (resource.data.submitterUid == request.auth.uid || isStaff());
      allow update, delete: if isStaff();
    }
  }
}

